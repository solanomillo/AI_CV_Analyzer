{% extends "base.html" %}
{% load static %}

{% block title %}Historial | AI CV Analyzer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/history.css' %}">
{% endblock %}

{% block content %}
<div class="history-page"> <!-- WRAPPER PRINCIPAL ESPEC칈FICO -->
    <div class="container">
        <!-- Encabezado del historial -->
        <header class="history-header history-fade-in">
            <div class="row">
                <div class="col-lg-8">
                    <h1 class="history-header-title">游늶 Historial de An치lisis</h1>
                    <p class="history-header-subtitle">
                        Revisa, descarga o elimina tus an치lisis de CV anteriores
                    </p>
                </div>
                <div class="col-lg-4 text-lg-end">
                    <a href="/" class="btn btn-primary btn-lg">
                        <i class="bi bi-plus-circle me-2"></i>
                        Nuevo An치lisis
                    </a>
                </div>
            </div>

            <!-- Estad칤sticas -->
            {% if analyses %}
            <div class="history-stats">
                <div class="history-stat-card">
                    <div class="history-stat-value">{{ analyses|length }}</div>
                    <div class="history-stat-label">Total de an치lisis</div>
                </div>
                <div class="history-stat-card">
                    <div class="history-stat-value">{{ analyses|length }}</div>
                    <div class="history-stat-label">Este mes</div>
                </div>
                <div class="history-stat-card">
                    <div class="history-stat-value">{{ unique_positions }}</div>
                    <div class="history-stat-label">Puestos diferentes</div>
                </div>
            </div>
            {% endif %}
        </header>

        <!-- Filtros y b칰squeda -->
        {% if analyses %}
        <div class="history-filters history-fade-in" style="animation-delay: 0.1s;">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="history-filter-group">
                        <label class="history-filter-label">
                            <i class="bi bi-search me-2"></i>Buscar an치lisis
                        </label>
                        <div class="history-search-box">
                            <i class="bi bi-search history-search-icon"></i>
                            <input type="text" 
                                   class="history-search-input" 
                                   placeholder="Buscar por puesto, fecha o palabras clave..."
                                   id="historySearch">
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="history-filter-group">
                        <label class="history-filter-label">
                            <i class="bi bi-filter me-2"></i>Ordenar por
                        </label>
                        <select class="history-filter-select" id="historySort">
                            <option value="newest">M치s recientes primero</option>
                            <option value="oldest">M치s antiguos primero</option>
                            <option value="position">Por puesto (A-Z)</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="history-filter-group">
                        <label class="history-filter-label">
                            <i class="bi bi-calendar me-2"></i>Fecha
                        </label>
                        <select class="history-filter-select" id="historyDateFilter">
                            <option value="all">Todas las fechas</option>
                            <option value="today">Hoy</option>
                            <option value="week">Esta semana</option>
                            <option value="month">Este mes</option>
                            <option value="year">Este a침o</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Lista de an치lisis -->
<section class="history-fade-in" style="animation-delay: 0.2s;">
    {% if analyses %}
        <div class="history-analysis-list" id="historyList">
            {% for analysis in analyses %}
            <div class="history-analysis-item">
                <div class="history-analysis-header">
                    <div>
                        <div class="history-analysis-title">
                            An치lisis #{{ forloop.counter }}
                        </div>
                        <div class="history-analysis-position">
                            <i class="bi bi-briefcase"></i>
                            {{ analysis.get_target_position_display|default:"Sin puesto especificado" }}
                        </div>
                    </div>
                    <div class="history-analysis-date">
                        <i class="bi bi-clock"></i>
                        {{ analysis.created_at|date:"d/m/Y H:i" }}
                    </div>
                </div>

                <div class="history-analysis-meta">
                    <div class="history-analysis-meta-item">
                        <i class="bi bi-calendar"></i>
                        {{ analysis.created_at|date:"F j, Y" }}
                    </div>
                    <div class="history-analysis-meta-item">
                        <i class="bi bi-clock-history"></i>
                        {{ analysis.created_at|timesince }} atr치s
                    </div>
                    {% if analysis.result_json.score %}
                    <div class="history-analysis-meta-item">
                        <i class="bi bi-star"></i>
                        Puntuaci칩n: {{ analysis.result_json.score }}/100
                    </div>
                    {% endif %}
                </div>

                <div class="history-analysis-actions">
                    <a href="{% url 'analysis_detail' analysis.id %}" 
                       class="history-action-btn view">
                        <i class="bi bi-eye"></i>
                        Ver Detalles
                    </a>
                    <a href="{% url 'download_summary' analysis.id %}" 
                       class="history-action-btn download">
                        <i class="bi bi-download"></i>
                        Descargar PDF
                    </a>
                    <button class="history-action-btn delete" 
                            data-analysis-id="{{ analysis.id }}"
                            data-analysis-position="{{ analysis.get_target_position_display|default:'este an치lisis' }}">
                        <i class="bi bi-trash"></i>
                        Eliminar
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

                <!-- Paginaci칩n (opcional) -->
                {% if analyses.has_other_pages %}
                <div class="history-pagination">
                    {% if analyses.has_previous %}
                    <a href="?page={{ analyses.previous_page_number }}" class="history-page-btn">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                    {% endif %}

                    {% for num in analyses.paginator.page_range %}
                        {% if analyses.number == num %}
                        <span class="history-page-btn active">{{ num }}</span>
                        {% else %}
                        <a href="?page={{ num }}" class="history-page-btn">{{ num }}</a>
                        {% endif %}
                    {% endfor %}

                    {% if analyses.has_next %}
                    <a href="?page={{ analyses.next_page_number }}" class="history-page-btn">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                    {% endif %}
                </div>
                {% endif %}

            {% else %}
                <!-- Estado vac칤o -->
                <div class="history-empty-state history-fade-in">
                    <div class="history-empty-icon">
                        <i class="bi bi-clock-history"></i>
                    </div>
                    <h3 class="history-empty-title">No hay an치lisis a칰n</h3>
                    <p class="history-empty-description">
                        A칰n no has realizado ning칰n an치lisis de CV. Comienza subiendo tu primer curr칤culum 
                        para obtener insights valiosos sobre c칩mo optimizarlo para sistemas ATS y reclutadores.
                    </p>
                    <a href="/" class="history-empty-cta">
                        <i class="bi bi-plus-circle"></i>
                        Realizar primer an치lisis
                    </a>
                </div>
            {% endif %}
        </section>
    </div>
</div> <!-- CIERRE DEL WRAPPER PRINCIPAL -->

<!-- Modal de confirmaci칩n para eliminar -->
<div class="history-modal-overlay" id="deleteModal">
    <div class="history-modal">
        <div class="history-modal-header">
            <div class="history-modal-icon">
                <i class="bi bi-exclamation-triangle"></i>
            </div>
            <h4 class="history-modal-title">Confirmar eliminaci칩n</h4>
        </div>
        <div class="history-modal-body">
            <p>쮼st치s seguro de que quieres eliminar el an치lisis de <strong id="modalPosition"></strong>?</p>
            <p class="text-light-emphasis small">
                <i class="bi bi-info-circle me-1"></i>
                Esta acci칩n no se puede deshacer y perder치s todos los datos de este an치lisis.
            </p>
        </div>
        <div class="history-modal-actions">
            <button class="history-modal-btn cancel" id="cancelDelete">
                Cancelar
            </button>
            <button class="history-modal-btn confirm" id="confirmDelete">
                S칤, eliminar
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    src='{% static "js/history.js" %}'
</script>
{% endblock %}